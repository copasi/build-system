#!/usr/bin/env bash

if [ _${BUILD_SYSTEM} != _"$(dirname "$(dirname "$(readlink -f "$0")")")" ] ; then
  . "$(dirname "$(dirname "$(readlink -f "$0")")")"/.variables
fi

PROGNAME="$(basename "$0")"
export DIR_SUFFIX="$(basename "$0")"
pushd ${BUILD_SYSTEM}

# Location of the COPASI sources
export COPASI_COMMON_BUILD_SYSTEM="$(pwd)"
export COPASI_SOURCES="${COPASI_COMMON_BUILD_SYSTEM}/git/COPASI.${DIR_SUFFIX}"
export COPASI_SETUP_DIR="${COPASI_COMMON_BUILD_SYSTEM}/packages/setup.${DIR_SUFFIX}"

echo ${COPASI_SOURCES}
# Upload information
export COPASI_SCP="scp"
export COPASI_UPLOAD="deploy:environment/upload/stage"

# Programs
AWK=${COPASI_AWK:-gawk}

clean=false
local=false
comment=
branch=master
tag=

[ -e .status.${PROGNAME} ] && . .status.${PROGNAME}

while [ _"$1" != _ ]; do
  case $1 in
  --clean)
    export clean=true
    ;;

  --local)
    local=true
    ;;

  --comment)
    comment=$2
    shift
    ;;

  --branch)
    branch=$2
    shift
    ;;

  --tag)
    tag=$2
    shift
    ;;
  esac
 
  shift
done

echo comment=$comment > .status.${PROGNAME}
echo branch=$branch >> .status.${PROGNAME}

# Update the sources
pushd "${COPASI_SOURCES}"

git fetch --all

if [ "$local" == false ]; then
  git reset --hard origin/${branch}
fi

if [ _"$tag" != _"" ]; then
  git checkout tags/$tag
fi

gitTools/initTools

# Determine the COPASI version
gitTools/UpdateCopasiVersion --force

# Set the version comment
sed -e 's/COPASI_VERSION_COMMENT.*/COPASI_VERSION_COMMENT "'$comment'"/' \
  copasi/CopasiVersion.h > $$ && mv $$ copasi/CopasiVersion.h
popd

build .

popd

export COPASI_PACKAGE="Linux-32bit"

rm -rf "${COPASI_SETUP_DIR}"/COPASI*
export BUILD_ROOT="${COPASI_COMMON_BUILD_SYSTEM}/build/COPASI.${DIR_SUFFIX}"

# Only executed for 64 bit Linux
# (cd ${BUILD_ROOT}; make package_source)

"${COPASI_SOURCES}/LinuxTGZ/create.sh" 'COPASI'
"${COPASI_SOURCES}/LinuxTGZ/create.sh" 'Java-Bindings'
"${COPASI_SOURCES}/LinuxTGZ/create.sh" 'C#-Bindings'
# "${COPASI_SOURCES}/LinuxTGZ/create.sh" 'Python-Bindings'

if [ "_${COPASI_SCP}" != "_" ]; then
  major=`${AWK} -- '$2 ~ "COPASI_VERSION_MAJOR" {print $3}' "${COPASI_SOURCES}/copasi/CopasiVersion.h"`
  minor=`${AWK} -- '$2 ~ "COPASI_VERSION_MINOR" {print $3}' "${COPASI_SOURCES}/copasi/CopasiVersion.h"`
  build=`${AWK} -- '$2 ~ "COPASI_VERSION_BUILD" {print $3}' "${COPASI_SOURCES}/copasi/CopasiVersion.h"`
  modified=`${AWK} -- '$2 ~ "COPASI_VERSION_MODIFIED" {print $3}' "${COPASI_SOURCES}/copasi/CopasiVersion.h"`
  comment=`${AWK} -- '$2 ~ "COPASI_VERSION_COMMENT" {print $3}' "${COPASI_SOURCES}/copasi/CopasiVersion.h"`
  
  sourceVersion=${major}.${minor}.${build}
  targetVersion=$sourceVersion
  if [ $modified == true ]; then
    targetVersion=${targetVersion}+
  fi

  # Only executed for 64 bit Linux
  # ${COPASI_SCP} "${BUILD_ROOT}"/COPASI-${sourceVersion}-Source.tar.gz "${COPASI_UPLOAD}/COPASI-${targetVersion}-Source.tar.gz"
  ${COPASI_SCP} "${COPASI_SETUP_DIR}"/COPASI-${sourceVersion}-${COPASI_PACKAGE}.sh "${COPASI_UPLOAD}/COPASI-${targetVersion}-${COPASI_PACKAGE}.sh"
  ${COPASI_SCP} "${BUILD_ROOT}"/copasi/CopasiSE/CopasiSE "${COPASI_UPLOAD}/AllSE/Linux/CopasiSE-${targetVersion}"
  ${COPASI_SCP} "${COPASI_SETUP_DIR}"/COPASI-${sourceVersion}-Java-Bindings-${COPASI_PACKAGE}.tar.gz "${COPASI_UPLOAD}/COPASI-${targetVersion}-Java-Bindings-${COPASI_PACKAGE}.tar.gz"
  ${COPASI_SCP} "${COPASI_SETUP_DIR}"/COPASI-${sourceVersion}-C#-Bindings-${COPASI_PACKAGE}.tar.gz "${COPASI_UPLOAD}/COPASI-${targetVersion}-C#-Bindings-${COPASI_PACKAGE}.tar.gz"
  # ${COPASI_SCP} "${COPASI_SETUP_DIR}"/COPASI-${sourceVersion}-Python-2.7-Bindings-${COPASI_PACKAGE}.tar.gz "${COPASI_UPLOAD}/COPASI-${targetVersion}-Python-2.7-${COPASI_PACKAGE}.tar.gz"
fi

