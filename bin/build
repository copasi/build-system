#!/usr/bin/env bash

BUILDROOT=$(dirname "$(readlink -f "$0")")

pushd "${BUILDROOT}"

rebuild=${clean:=false}

while [ _"$1" != _ ]; do
  case $1 in
  --rebuild)
    rebuild=true
    ;;

  *)
    toBeBuild="${toBeBuild} $1"
    ;;
  esac
 
  shift
done

toBeBuild=${toBeBuild:="."}

function buildOne () {
  export BUILD_DIR="${BUILD_DIR}/COPASI.${DIR_SUFFIX}"

  if [ ${rebuild} = true ] || [ ! -e "${BUILD_DIR}" ] || [ ! -e "${BUILD_DIR}/CMakeCache.txt" ]; then
    [ -e "${BUILD_DIR}" ] && rm -rf "${BUILD_DIR}"
      
    options="-DENABLE_JAVA=ON -DENABLE_CSHARP=ON -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DSELECT_QT=${SELECT_QT}"
    
    [ -e "${BUILD_DIR}" ] || mkdir -p "${BUILD_DIR}"
    
    pushd "${BUILD_DIR}"
    echo cmake ${COPASI_CMAKE_OPTIONS} ${options} "${COPASI_SOURCES}"
    cmake ${COPASI_CMAKE_OPTIONS} ${options} "${COPASI_SOURCES}"
    popd
  else
    touch "${COPASI_SOURCES}/CMakeLists.txt"
  fi
  
  pushd "${BUILD_DIR}"
  make -j 3
  popd
}

for b in ${toBeBuild}; do
  if [ _$1 != _. -a _$1 != _ ]; then
    pushd $1
    LOG_SUFFIX=".$1"
  else
    LOG_SUFFIX=""
  fi
  
  buildOne $b 2>&1 | tee "${LOG_DIR}/COPASI${LOG_SUFFIX}.${DIR_SUFFIX}"

  [ _$1 != _. -a _$1 != _ ] && popd $1
done

popd
