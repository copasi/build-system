#!/usr/bin/env bash

BUILDROOT="$(dirname "$(dirname "$(greadlink -f "$0")")")"

pushd "${BUILDROOT}"

rebuild=${clean:=false}

while [ _"$1" != _ ]; do
  case $1 in
  --rebuild)
    rebuild=true
    ;;

  *)
    toBeBuild="${toBeBuild} $1"
    ;;
  esac
 
  shift
done

toBeBuild=${toBeBuild:="."}

function buildOne () {
  . .variables

  export BUILD_DIR="${BUILD_DIR}/COPASI.${DIR_SUFFIX}"

  if [ ${rebuild} = true ] || [ ! -e "${BUILD_DIR}" ] || [ ! -e "${BUILD_DIR}/CMakeCache.txt" ]; then
    [ -e "${BUILD_DIR}" ] && rm -rf "${BUILD_DIR}"
      
    java_include="${JAVA_HOME}/include"
    java_lib="${JAVA_HOME}/libexec/openjdk.jdk/Contents/Home/lib/"
    JAVA_OPTS="-DJAVA_INCLUDE_PATH=${java_include} -DJAVA_INCLUDE_PATH2=${java_include} -DJAVA_AWT_INCLUDE_PATH=${java_include} -DJAVA_JVM_LIBRARY=${java_lib}/server/libjvm.dylib -DJAVA_AWT_LIBRARY=${java_lib}/libawt.dylib"
    options="-DSWIG_EXECUTABLE=${SWIG_EXECUTABLE} -DENABLE_JAVA=ON -DENABLE_CSHARP=ON -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DSELECT_QT=${SELECT_QT} ${JAVA_OPTS} -DF2C_INTEGER=int -DF2C_LOGICAL=int -DQt6Widgets_UIC_EXECUTABLE=${QTDIR}/share/qt/libexec/uic -DWITH_DATAVISUALIZATION_NAMESPACES=OFF -DJAVA_COMPATIBILITY=1.7 "
    
    [ -z "${COPASI_CMAKE_OPTIONS}" ] || COMMON_CMAKE_OPTIONS="$(echo ${COPASI_CMAKE_OPTIONS} | sed -e 's/;/ /g')"
    [ -e "${BUILD_DIR}" ] || mkdir -p "${BUILD_DIR}"
    
    pushd "${BUILD_DIR}"
    echo cmake -G Ninja ${COMMON_CMAKE_OPTIONS} ${options} "${COPASI_SOURCES}"
    cmake -G Ninja ${COMMON_CMAKE_OPTIONS} ${options} "${COPASI_SOURCES}"
    popd
  else
    touch "${COPASI_SOURCES}/CMakeLists.txt"
  fi
  
  pushd "${BUILD_DIR}"
  ninja
  popd
}

for b in ${toBeBuild}; do
  if [ _$1 != _. -a _$1 != _ ]; then
    pushd $1
    LOG_SUFFIX=".$1"
  else
    LOG_SUFFIX=""
  fi
  
  buildOne $b 2>&1 | tee "${LOG_DIR}/COPASI${LOG_SUFFIX}.${DIR_SUFFIX}"

  [ _$1 != _. -a _$1 != _ ] && popd $1
done

popd
