OLD_BUILD_SYSTEM="${BUILD_SYSTEM}"
BUILD_SYSTEM="$(dirname "$(greadlink -f "$BASH_SOURCE")")"

if [ _${OLD_BUILD_SYSTEM} != _${BUILD_SYSTEM} ]; then
  export BUILD_SYSTEM
  export SAVED_PATH="${SAVED_PATH:=$PATH}"
  export BUILD_TYPE=${BUILD_TYPE:-Release}

  if [ ${BUILD_TYPE} == Release ]; then
    export INSTALL_DIR=${BUILD_SYSTEM}/local
    export BUILD_DIR=${BUILD_SYSTEM}/build
    export LOG_DIR=${BUILD_SYSTEM}/log
  else
    export INSTALL_DIR=${BUILD_SYSTEM}/local.debug
    export BUILD_DIR=${BUILD_SYSTEM}/build.debug
    export LOG_DIR=${BUILD_SYSTEM}/log.debug
  fi

  export CC=clang
  export CXX=clang++
  export MACOSX_DEPLOYMENT_TARGET=10.13
  export SDK=${BUILD_SYSTEM}/MacOSX10.13.sdk

  export SELECT_QT=Qt5
  export QTDIR=/usr/local/opt/qt@5

  export PATH="${QTDIR}/bin:${BUILD_SYSTEM}/bin:/Library/Frameworks/Mono.framework/Versions/Current/bin:${SAVED_PATH}"

  export COMBINE_DIR="${INSTALL_DIR}"
  export CROSSGUID_DIR="${INSTALL_DIR}"
  export EXPAT_DIR="${INSTALL_DIR}"
  export LIBSBML_DIR="${INSTALL_DIR}"
  export LIBSEDML_DIR="${INSTALL_DIR}"
  export MML_DIR="${INSTALL_DIR}"
  export QWT_DIR="${INSTALL_DIR}"
  export QWTPLOT3D_DIR="${INSTALL_DIR}"
  export RAPTOR_DIR="${INSTALL_DIR}"
  export SBW_DIR="${INSTALL_DIR}"
  export NATIVEJIT_DIR="${INSTALL_DIR}"
  export CPUFEATURES_DIR="${INSTALL_DIR}"

  export JAVA_HOME=/usr/local/opt/openjdk@17/
  export SWIG_EXECUTABLE=/usr/local/opt/swig@3/bin/swig
  export PKG_CONFIG_PATH="${INSTALL_DIR}/lib/pkgconfig:${PKG_CONFIG_PATH}"

  export COPASI_CFLAGS="-isysroot ${SDK}"
  export COPASI_CXXFLAGS="-isysroot ${SDK}"
  export COPASI_LDFLAGS="-isysroot ${SDK} -Wl,-syslibroot,${SDK}"

  COPASI_CMAKE_OPTIONS="-DCMAKE_OSX_DEPLOYMENT_TARGET=${MACOSX_DEPLOYMENT_TARGET}"
  COPASI_CMAKE_OPTIONS="${COPASI_CMAKE_OPTIONS};-DCMAKE_OSX_SYSROOT=${SDK}"
  COPASI_CMAKE_OPTIONS="${COPASI_CMAKE_OPTIONS};-DCMAKE_CXX_FLAGS=-Wno-inconsistent-missing-override"
  export COPASI_CMAKE_OPTIONS
fi
